<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Spotify Reactive Tubes Cursor</title>

<style>
  body, html, #app { margin: 0; width: 100%; height: 100%; }
  body { touch-action: none; background: black; }
  #app { height: 100%; font-family: "Montserrat", serif; }

  .hero {
    position: relative;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    pointer-events: none;
    text-align: center;
  }

  h1, h2 {
    margin: 0;
    padding: 0;
    color: white;
    text-shadow: 0 0 20px rgba(0,0,0,1);
    pointer-events: auto;
    user-select: none;
  }

  h1 { font-size: 80px; font-weight: 700; text-transform: uppercase; }
  h2 { font-size: 50px; font-weight: 500; text-transform: uppercase; }

  #canvas {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    overflow: hidden;
  }

  button {
    pointer-events: auto;
    padding: 12px 26px;
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 8px;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: .2s;
  }

  button:disabled { opacity: 0.3; cursor: not-allowed; }
  button:hover:not(:disabled) { background: rgba(255,255,255,0.3); }

  /* Fix link color always white */
  .hero a:link,
  .hero a:visited,
  .hero a:hover,
  .hero a:active {
    color: #fff;
    text-decoration: none;
    pointer-events: auto;
  }

  /* Profile picture in top-right */
  #profile {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    position: fixed;
    top: 15px;
    right: 15px;
    border: 2px solid white;
    object-fit: cover;
    display: none;
    z-index: 1000;
  }
</style>

<script src="https://sdk.scdn.co/spotify-player.js"></script>

<script type="module">
import TubesCursor from "https://cdn.jsdelivr.net/npm/threejs-components@0.0.19/build/cursors/tubes1.min.js";

/*****************************************************
 * 1. GLOBAL VARIABLES
 *****************************************************/
let accessToken = null;
let player = null;
let spotifyDeviceId = null;

const CLIENT_ID = "d48f2a5c8df746db9d8a75b1edad2a71";
const REDIRECT_URI = "https://spoti-cursor.vercel.app/";

/*****************************************************
 * 2. PKCE HELPERS
 *****************************************************/
async function generateCodeVerifier(length) {
  let text = "";
  const possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  for (let i = 0; i < length; i++) {
    text += possible[Math.floor(Math.random() * possible.length)];
  }
  return text;
}

async function generateCodeChallenge(verifier) {
  const data = new TextEncoder().encode(verifier);
  const digest = await crypto.subtle.digest("SHA-256", data);
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

/*****************************************************
 * 3. REDIRECT TO SPOTIFY AUTH
 *****************************************************/
async function redirectToSpotifyAuth() {
  const verifier = await generateCodeVerifier(128);
  const challenge = await generateCodeChallenge(verifier);
  localStorage.setItem("pkce_verifier", verifier);

  const params = new URLSearchParams({
    client_id: CLIENT_ID,
    response_type: "code",
    redirect_uri: REDIRECT_URI,
    code_challenge_method: "S256",
    code_challenge: challenge,
    scope: "user-read-email user-read-private streaming"
  });

  window.location = "https://accounts.spotify.com/authorize?" + params.toString();
}

/*****************************************************
 * 4. EXCHANGE CODE → ACCESS TOKEN
 *****************************************************/
async function getAccessToken(code) {
  const verifier = localStorage.getItem("pkce_verifier");

  const params = new URLSearchParams({
    client_id: CLIENT_ID,
    grant_type: "authorization_code",
    code: code,
    redirect_uri: REDIRECT_URI,
    code_verifier: verifier
  });

  const res = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: params
  });

  return await res.json();
}

/*****************************************************
 * 5. HANDLE RETURN FROM SPOTIFY LOGIN
 *****************************************************/
async function handleSpotifyReturn() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  if (!code) return;

  const data = await getAccessToken(code);
  accessToken = data.access_token;

  console.log("✔ Access Token:", accessToken);

  document.getElementById("connect").disabled = true;
  document.getElementById("play").disabled = false;

  await loadUserProfile();

  window.history.replaceState({}, document.title, REDIRECT_URI);
}

/*****************************************************
 * 6. LOAD USER’S SPOTIFY PROFILE PICTURE
 *****************************************************/
async function loadUserProfile() {
  const res = await fetch("https://api.spotify.com/v1/me", {
    headers: { Authorization: "Bearer " + accessToken }
  });
  const data = await res.json();

  if (data.images && data.images.length > 0) {
    const img = document.getElementById("profile");
    img.src = data.images[0].url;
    img.style.display = "block";
  }
}

/*****************************************************
 * 7. SPOTIFY PLAYER INIT
 *****************************************************/
window.onSpotifyWebPlaybackSDKReady = () => {
  console.log("Spotify SDK Ready");

  player = new Spotify.Player({
    name: "Tubes Musical Cursor",
    getOAuthToken: cb => cb(accessToken),
    volume: 0.8
  });

  player.addListener("ready", ({ device_id }) => {
    console.log("Player ready:", device_id);
    spotifyDeviceId = device_id;
  });

  player.connect();
};

/*****************************************************
 * 8. DOM READY
 *****************************************************/
window.addEventListener("DOMContentLoaded", async () => {
  await handleSpotifyReturn();

  const canvas = document.getElementById("canvas");

  const app = TubesCursor(canvas, {
    tubes: {
      colors: ["#f967fb", "#53bc28", "#6958d5"],
      lights: {
        intensity: 200,
        colors: ["#83f36e", "#fe8a2e", "#ff008a", "#60aed5"]
      }
    }
  });

  const connectBtn = document.getElementById("connect");
  const playBtn = document.getElementById("play");

  connectBtn.onclick = redirectToSpotifyAuth;

  playBtn.onclick = async () => {
    if (!accessToken) return alert("No access token yet.");
    if (!spotifyDeviceId) return alert("Player not ready, try again.");

    await fetch(
      "https://api.spotify.com/v1/me/player/play?device_id=" + spotifyDeviceId,
      {
        method: "PUT",
        headers: {
          Authorization: "Bearer " + accessToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          uris: ["spotify:track:1Iq8oo9XkmmvCe2zCH8asQ"]
        })
      }
    );

    startAudioReactive(app);
  };
});

/*****************************************************
 * 9. AUDIO REACTIVE VISUALIZER
 *****************************************************/
let audioCtx, analyser, freqData;

function startAudioReactive(app) {
  audioCtx = new AudioContext();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  freqData = new Uint8Array(analyser.frequencyBinCount);

  const wait = setInterval(() => {
    const audio = document.querySelector("audio");
    if (!audio) return;

    clearInterval(wait);

    const src = audioCtx.createMediaElementSource(audio);
    src.connect(analyser);
    analyser.connect(audioCtx.destination);

    animate();
  }, 250);

  function animate() {
    requestAnimationFrame(animate);
    analyser.getByteFrequencyData(freqData);

    const bass = avg(freqData.slice(0, 40));
    const mids = avg(freqData.slice(40, 200));
    const highs = avg(freqData.slice(200, 512));

    app.tubes.setSize(1 + bass * 0.01);
    app.tubes.setSpeed(0.6 + mids * 0.005);
    app.tubes.setLightsIntensity(150 + highs);
  }
}

function avg(arr) {
  return arr.reduce((a, b) => a + b, 0) / arr.length;
}
</script>
</head>
<body>

<img id="profile">

<div id="app">
  <canvas id="canvas"></canvas>

  <div class="hero">
    <h1>Spotify</h1>
    <h2>Musical Cursor</h2>

    <a target="_blank" href="https://github.com/zen-dts/spoti-cursor">
      Designed by Luminesco
    </a>

    <button id="connect">Connect Spotify</button>
    <button id="play" disabled>Play Song</button>
  </div>
</div>

</body>
</html>
