<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Spotify Reactive Tubes Cursor</title>

<style>
  body, html, #app { margin: 0; width: 100%; height: 100%; }
  body { touch-action: none; background: black; }
  #app { height: 100%; font-family: "Montserrat", serif; }
  .hero {
    position: relative; height: 100%;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 10px;
    pointer-events: none;
  }
  h1, h2 { color: white; text-shadow: 0 0 20px black; margin: 0; pointer-events: auto; }
  h1 { font-size: 80px; font-weight: 700; text-transform: uppercase; }
  h2 { font-size: 60px; font-weight: 500; text-transform: uppercase; }
  #canvas {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    overflow: hidden;
  }
  button {
    pointer-events: auto;
    padding: 12px 26px;
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 8px;
    color: #fff; font-size: 16px;
    cursor: pointer; backdrop-filter: blur(10px);
  }
  button:disabled { opacity: 0.3; cursor: not-allowed; }
  button:hover:not(:disabled) { background: rgba(255,255,255,0.3); }
</style>

<script src="https://sdk.scdn.co/spotify-player.js"></script>

<script type="module">
import TubesCursor from "https://cdn.jsdelivr.net/npm/threejs-components@0.0.19/build/cursors/tubes1.min.js";

/* -----------------------------------------------------
   1. Global variables
----------------------------------------------------- */
let accessToken = null;
let player = null;
let spotifyDeviceId = null;

const CLIENT_ID = "d48f2a5c8df746db9d8a75b1edad2a71";
const REDIRECT_URI = "https://spoti-cursor.vercel.app/";

/* -----------------------------------------------------
   2. PKCE Helper functions
----------------------------------------------------- */
async function generateCodeVerifier(len) {
  let text = "";
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  for (let i = 0; i < len; i++) text += chars[Math.floor(Math.random() * chars.length)];
  return text;
}

async function generateCodeChallenge(verifier) {
  const data = new TextEncoder().encode(verifier);
  const digest = await crypto.subtle.digest("SHA-256", data);
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

/* -----------------------------------------------------
   3. Redirect to Spotify login
----------------------------------------------------- */
async function redirectToSpotifyAuth() {
  const verifier = await generateCodeVerifier(128);
  const challenge = await generateCodeChallenge(verifier);

  localStorage.setItem("pkce_verifier", verifier);

  const params = new URLSearchParams({
    client_id: CLIENT_ID,
    response_type: "code",
    redirect_uri: REDIRECT_URI,
    code_challenge_method: "S256",
    code_challenge: challenge,
    scope: "streaming user-read-email user-read-private"
  });

  window.location = "https://accounts.spotify.com/authorize?" + params.toString();
}

/* -----------------------------------------------------
   4. Exchange code → token
----------------------------------------------------- */
async function getAccessToken(code) {
  const verifier = localStorage.getItem("pkce_verifier");

  const params = new URLSearchParams({
    client_id: CLIENT_ID,
    grant_type: "authorization_code",
    code: code,
    redirect_uri: REDIRECT_URI,
    code_verifier: verifier
  });

  const res = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: params
  });

  return await res.json();
}

/* -----------------------------------------------------
   5. Handle return from Spotify login
----------------------------------------------------- */
async function handleSpotifyReturn() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");

  if (!code) return;

  const data = await getAccessToken(code);
  accessToken = data.access_token;

  console.log("✔ Access Token:", accessToken);

  document.getElementById("connect").disabled = true;
  document.getElementById("play").disabled = false;

  // cleanup URL
  window.history.replaceState({}, document.title, REDIRECT_URI);
}

/* -----------------------------------------------------
   6. Initialize Spotify Player
----------------------------------------------------- */
window.onSpotifyWebPlaybackSDKReady = () => {
  console.log("Spotify SDK Ready");

  player = new Spotify.Player({
    name: "Tubes Musical Cursor",
    getOAuthToken: cb => cb(accessToken),
    volume: 0.8
  });

  player.addListener("ready", ({ device_id }) => {
    console.log("Ready with Device ID", device_id);
    spotifyDeviceId = device_id;
  });

  player.connect();
};

/* -----------------------------------------------------
   7. App Logic
----------------------------------------------------- */
window.addEventListener("DOMContentLoaded", async () => {
  await handleSpotifyReturn();

  // Tubes Cursor Init
  const canvas = document.getElementById("canvas");
  const app = TubesCursor(canvas, {
    tubes: {
      colors: ["#f967fb", "#53bc28", "#6958d5"],
      lights: {
        intensity: 200,
        colors: ["#83f36e", "#fe8a2e", "#ff008a", "#60aed5"]
      }
    }
  });

  // Buttons
  const connectBtn = document.getElementById("connect");
  const playBtn = document.getElementById("play");

  connectBtn.onclick = redirectToSpotifyAuth;

  playBtn.onclick = async () => {
    if (!spotifyDeviceId) return alert("Device not ready yet.");

    await fetch("https://api.spotify.com/v1/me/player/play?device_id=" + spotifyDeviceId, {
      method: "PUT",
      headers: {
        Authorization: "Bearer " + accessToken,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        uris: ["spotify:track:1Iq8oo9XkmmvCe2zCH8asQ"]
      })
    });

    startAudioReactive(app);
  };
});

/* -----------------------------------------------------
   8. Audio → Cursor Visuals
----------------------------------------------------- */
let audioCtx, analyser, freqData;

function startAudioReactive(app) {
  audioCtx = new AudioContext();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  freqData = new Uint8Array(analyser.frequencyBinCount);

  // Wait for Spotify's hidden audio element
  const wait = setInterval(() => {
    const audio = document.querySelector("audio");
    if (!audio) return;

    clearInterval(wait);
    const src = audioCtx.createMediaElementSource(audio);
    src.connect(analyser);
    analyser.connect(audioCtx.destination);

    animate();
  }, 200);

  function animate() {
    requestAnimationFrame(animate);
    analyser.getByteFrequencyData(freqData);

    const bass = avg(freqData.slice(0, 40));
    const mids = avg(freqData.slice(40, 200));
    const highs = avg(freqData.slice(200, 512));

    app.tubes.setSize(1 + bass * 0.01);
    app.tubes.setSpeed(0.6 + mids * 0.005);
    app.tubes.setLightsIntensity(150 + highs);
  }
}

function avg(arr) {
  return arr.reduce((a, b) => a + b, 0) / arr.length;
}
</script>
</head>
<body>

<div id="app">
  <canvas id="canvas"></canvas>
  <div class="hero">
    <h1>Spotify</h1>
    <h2>Musical Cursor</h2>
    <a target="_blank" href="https://github.com/zen-dts/spoti-cursor">Designed by Luminesco</a>

    <button id="connect">Connect Spotify</button>
    <button id="play" disabled>Play Song</button>
  </div>
</div>

</body>
</html>
